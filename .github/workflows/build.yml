name: Test Build Deploy

on:
  push:
    branches: [ "terraform" ]

    permissions:
      contents: read
jobs:
    terraform:
      name: "Terraform Pipeline"
      outputs:
        host: ${{ steps.terraform_output.outputs.public_ip }}
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      runs-on: ubuntu-latest
      environment: dev
      defaults:
        run:
          shell: bash
      steps:
        - name: Checkout
          uses: actions/checkout@v3

        - name: Terraform Init
          run: terraform init

        - name: Setup Terraform
          uses: hashicorp/setup-terraform@v1
          with:
            terraform_wrapper: false

        - name: Terraform Plan
          run: terraform plan

        - name: Terraform Apply
          run: terraform apply -auto-approve -input=false

        - name: Terraform Output
          id: terraform_output
          run: |
            echo public_ip=$(terraform output instance_public_ip | tr -d '"') >> $GITHUB_OUTPUT

      build:
        name: "build"
        runs-on: ubuntu-latest
        steps:
          - name: Checkout
            uses: actions/checkout@v3
          - name: Setup java
            uses: actions/setup-java@v3
            with:
              distribution: corretto
              java-version: 17
          - name: Build
            run:
              cd esop_trading && ./gradlew build
          - name: Copy jar file to artifacts
            uses: actions/upload-artifact@v3
            with:
              name: esop-trading-1.0
              path: build/libs/esop-0.1-all.jar


      test:
          runs-on: ubuntu-latest
          steps:
              - name: Checkout
                uses: actions/checkout@v3
                  - name: Setup java
                    uses: actions/setup-java@v3
                    with:
                      distribution: corretto
                      java-version: 17
                  - name: Test
                    run: cd esop_trading && s./gradlew test








